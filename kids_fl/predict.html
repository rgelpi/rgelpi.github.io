<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>


$(document).ready(function(){

	const urlParams = new URLSearchParams(window.location.search)
	if(urlParams.has('predict')){
		var predictions = JSON.parse(urlParams.get('predict'))
	}else{
		var predictions = [1, 3, 4, 6, 9]
	}
	
	$('.ghostbars').hide();
	$('.ghostbars').children('div').css('background-color','rgba(255, 255, 255, 0)')
	
	const allBars = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]

	var numApples = [1, 2, 3, 4, 5, 6, 7, 7, 6, 5, 4, 3, 2, 1]
	// specify with function
	if(urlParams.get('function') === 'gaussian'){
		numApples = [1, 2, 5, 8, 11, 13, 14, 14, 13, 11, 8, 5, 2, 1]
	}else if(urlParams.get('function') === 'neglin'){
		numApples = [14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
	}else if(urlParams.get('function') === 'expon'){
		numApples = [1, 1, 1, 1, 1, 2, 2, 2, 3, 3, 4, 6, 9, 14]
	}
	
	var barsChosen = predictions
	
	var remainingBars = allBars.filter(value => !barsChosen.includes(value))
	var unselectedBars = remainingBars.filter((v,i) => { return (i%2)} )
	var selectedBars = remainingBars.filter((v,i) => { return !(i%2)} )
	
// 	console.log(unselectedBars)
	 
	var applesAtBarsChosen = barsChosen.map((c) => { return numApples[c] })
	
	var addApples = barsChosen.map((c) => {
		var bar = c+1
		var whichbar = '.container :nth-child('+bar+')'
		var apples = numApples[c]
// 		console.log('Bar: ' + bar + '; Number of apples: ' + numApples[c])
		$(whichbar).toggleClass("clicked");
		for (let i = 0; i < apples; i++){
			$(whichbar).each(function(idx, li) {
				var obj = $(li);
				if(obj.hasClass('bar')){
					obj.append('<div class="img"><img class="apple" src="img/apple.png"></div>')
				}
			});
		}
		
	});
	
	for(let i = 0; i < 14; i++){
		$('.trees').append('<div class="tree"><img src="img/tree.png"></div>')
	}
	
	var disableBars = unselectedBars.map((c) => {
		var bar = c+1
		var whichbar = '.container :nth-child('+bar+')'
		$(whichbar).toggleClass("unselected");
	});
	
	var clickableBars = selectedBars.map((c) => {
		var bar = c+1
		var whichbar = '.container :nth-child('+bar+')'
		$(whichbar).addClass('clickable');
	});
	
	
    $('.clickable').click(function() {
        if($(this).children('div').children('img').length < 14){
        	$(this).append('<div class="img"><img class="apple" src="img/clear_apple.png"></div>');
        }
      	if(selectedBars.map(element => {
            var bar = element+1
            var whichbar = '.container :nth-child('+bar+')'
            return $(whichbar).children('div').children('img').length > 0
        }).every((v) => v === true)){
			$('.button').removeClass('disabled');
		}  
    });

	var done = false;
	$('.button').click(function() {
		if(!done){
		var appsoluteError = selectedBars.map((c) => {
			var bar = c+1
			var whichbar = '.container :nth-child('+bar+')'
			var trueApples = numApples[c]
			var guessedApples = $(whichbar).children('div').children('img').length
			
			return Math.abs(trueApples - guessedApples)
			
		});
		
		var guessedApples = selectedBars.map((c) => {
			var bar = c+1
			var whichbar = '.container :nth-child('+bar+')'
			var guessedApples = $(whichbar).children('div').children('img').length
			
			return guessedApples
			
		});
		
		var applesAtBarsSelected = selectedBars.map((c) => { return numApples[c] })
	
		var addSelectedApples = selectedBars.map((c) => {
			var bar = c+1
			var whichbar = '.ghostbars :nth-child('+bar+')'
			var apples = numApples[c]
			for (let i = 0; i < apples; i++){
			$(whichbar).each(function(idx, li) {
				var obj = $(li);
				if(obj.hasClass('bar')){
					obj.append('<div class="img"><img class="apple" src="img/apple.png"></div>')
				}
			});
				$(whichbar).children('div').children('img').addClass('ghostapple');
				$(whichbar).children('div').children('img').css('cursor', 'not-allowed');
				$('.container :nth-child('+bar+')').removeClass('clickable');
				$('.container :nth-child('+bar+')').children('div').children('img').css('cursor', 'not-allowed');
				$('.container :nth-child('+bar+')').children('div').children('img').css('pointer-events', 'none');
			}
		});
		
		// localStorage['guessedApples'] = JSON.stringify(guessedApples)
		// localStorage['trueApples'] = JSON.stringify(trueApples)
		$('.ghostbars').show();
		done = true;
		document.getElementById('error').innerHTML = "Your error was: " + appsoluteError.reduce((a, b) => a + b, 0) + " apples!"
		document.getElementById('buttontext').innerHTML = "Finish!"
		}else{
		$('div').hide()
		$('#hooray').show()
		}
		
	});

});






</script>
<style>

.clickable {
	
}

.container {
	display: flex;
	height: calc(100vh - 300px);
	width: 90%;
	margin-left: 5%;
	text-align: center;
	margin-top: 20px;
}

.bar {
	margin-left: 0.5%;
	margin-right: 0.5%;
	flex: 1 1 0px;
	flex-grow: 1;
	padding: 20px 20px;
	border: 5px #fff;
	text-align: center;
	display: flex;
	background-color: lightblue;
	justify-content: flex-end;
    flex-direction: column;
}

.whitespace {

	width: 5%;
	height: auto;

}

.bar.clicked {
	background-color: white;
	pointer-events: none;
}

.bar.unselected {
	background-color: lightgrey;
	pointer-events: none;
}

.apple {
	position: relative;
	bottom: 0;
}

.ghostapple {
	opacity: 0.3;
}

.text, .end {
	text-align: center;
	flex: 1 1 0px;
	max-width: 100%;
	font-family: Noto, Geneva, Sans-serif;
	font-size: 30px;
}

.button {
  background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 10px 10px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 24px;
  transition-duration: 0.4s;
}

.button:hover {
  background-color: #2C8F30; /* Green */
}

.disabled {
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;
}

.disabled:hover {
  background-color: #4CAF50; /* Green */
}

.monkey {
  position: absolute;
  margin-top: -290px;
  margin-left: 1400px;
}

.trees {
	width: 90%;
	margin-left: 5%;
	flex: 1 1 0px;
	height: 100px;
	text-align: center;
	display: flex;
	background-color: white;
    flex-direction: row;
}

.tree {
	position: relative;
	flex: 1 1 0px;
	margin-left: 0.5%;
	margin-right: 0.5%;
	padding: 5px 5px;
}

.ghostbars {
	position: absolute;
	height: calc(100vh - 300px);
	display: flex;
	width: 90%;
	margin-left: 5%;
	text-align: center;
	cursor: not-allowed;
	
}

img {
	max-width: 100%;
	aspect-ratio: 1/1;
}

body {
	touch-action: manipulation;
}

</style>
</head>
<body>

<div hidden id="ghostbars" class="ghostbars">

 		<div class="bar">
 			
 		</div> 	
		
 		<div class="bar">
 			
 		</div> 	
 		
 		<div class="bar">
 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 		 		 		 		
 		
 		<div class="bar">

 			
 		</div>
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 
 		
 		<div style="width:16px;"></div>		 		 		 		
 			
</div>

<div id="container" class="container">

 		<div class="bar">
 			
 		</div> 	
		
 		<div class="bar">
 			
 		</div> 	
 		
 		<div class="bar">
 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 		 		 		 		
 		
 		<div class="bar">

 			
 		</div>
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 	
 		
 		<div class="bar">

 			
 		</div> 		 		 		 		
 			
</div>

<div class="trees">

</div>

<div class='text'>
 	<p><a id="error">Predict the <span style='color: #72bcd4;'>blue</span> bars...</a></p>
</div>
<!-- 
<div class='monkey' id='monkey'>
	<img src="img/monkey.png" width=100px>
</div>
 -->
<div class='end'>
	<button class="button disabled" id="button"><a id="buttontext">Make my predictions!</a></button>
</div>

<div hidden id="hooray" class="text" hidden="true">
    <p style="font-size:28px;">
        Thanks for playing!
    </p>
    <p>
        <img src="./img/hooray.png">
    </p>
</div>

</body>
</html>